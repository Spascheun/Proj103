<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Contrôle Robot Interactif</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f0f0;
        }
        .buttons {
            margin-bottom: 40px;
        }
        button {
            font-size: 1.2em;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            user-select: none;
            width: 90px;
        }
        button:active {
            background-color: #0056b3;
        }
        .joystick {
            margin: auto;
            width: 150px;
            height: 150px;
            background: #ccc;
            border-radius: 50%;
            position: relative;
            box-shadow: inset 0 0 10px #999;
            touch-action: none; /* Prevent default touch */
        }
        .knob {
            width: 60px;
            height: 60px;
            background: #007bff;
            border-radius: 50%;
            position: absolute;
            top: 45px;
            left: 45px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            user-select: none;
            touch-action: none;
            transition: top 0.1s, left 0.1s;
        }
        #coordinates {
            margin-top: 20px;
            font-family: monospace;
            font-weight: bold;
        }
        #joystick-zone {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Contrôle Robot Interactif</h1>
    <div class="buttons">
        <button id="up">Avant</button><br />
        <button id="left">Gauche</button>
        <button id="down">Arrière</button>
        <button id="right">Droite</button>
    </div>
    <div id="joystick-zone">
        <div class="joystick" id="joystick">
            <div class="knob" id="knob"></div>
        </div>
    </div>
    <div id="coordinates">(0, 0)</div>

    <script src="https://unpkg.com/nipplejs@0.10.2/dist/nipplejs.js"></script>
    <script type="module">

        const DEFAULT_SERVER_TYPE = 'websocket';

        // Importation du module client et initialisation
        import { createClient } from './javaScript/main.js';
        console.log('Initialisation d\'un client..');
        (async () => {
            try {
                window.robotClient = await createClient(DEFAULT_SERVER_TYPE);
                window.robotClient.sendCommand(0,0); // Envoi de commande initiale
         
            } catch (e) {
                console.error('Impossible d\'initialiser le client:', e);
            }
        })();


        // Gestion boutons directionnels
        const buttons = ['up','down','left','right'];
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            btn.addEventListener('mousedown', () => {
                console.log(id + ' button pressed');
            });
            btn.addEventListener('mouseup', () => {
                console.log(id + ' button released');
            });
            btn.addEventListener('touchstart', e => {
                e.preventDefault();
                console.log(id + ' button pressed (touch)');
            }, {passive: false});
            btn.addEventListener('touchend', e => {
                e.preventDefault();
                console.log(id + ' button released (touch)');
            }, {passive: false});
        });


        // Initialisation du joystick virtuel avec nipplejs
        const joystickZone = document.getElementById('joystick');
        const joystick = nipplejs.create({
            zone: joystickZone,
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'blue',
            size: 150,
        });
        joystick.on('move', (evt, data) => {
            if (data && data.vector) {
                const x = data.vector.x.toFixed(2);
                const y = data.vector.y.toFixed(2);
                document.getElementById('coordinates').textContent = `(${x}, ${y}) \n client type: ${window.robotClient.type}`;
                window.robotClient.sendCommand(x, y);
            }
        });
        joystick.on('end', () => {
            document.getElementById('coordinates').textContent = `(0, 0) \n client type: ${window.robotClient.type}`;
            window.robotClient.sendCommand(0, 0);
        });


    </script>
</body>
</html>
